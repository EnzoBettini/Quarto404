<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quarto 404 - Prototípo Narrativo</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #111;
            color: #eee;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            border: 2px solid #444;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 5px;
            z-index: 2;
        }

        #message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            display: none;
            z-index: 2;
            color: #fff;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div id="hud">
            <p>Fragmentos: {{ fragmentos }}/3</p>
            <p v-if="porta404">Quarto 404: ABERTO</p>
            <p v-else>Quarto 404: TRANCADO</p>
        </div>
        <div id="message"><span id="message-text"></span></div>
    </div>

    <script>
        const state = {
            fragmentos: 0,
            porta404: false
        };

        const app = new Vue({
            el: '#hud',
            data: state
        });

        const showMessage = (msg, dur = 2000) => {
            const box = document.getElementById('message');
            const text = document.getElementById('message-text');
            text.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', dur);
        };

        class CenaPrincipal extends Phaser.Scene {
            constructor() {
                super('CenaPrincipal');
            }

            create() {
                this.add.rectangle(400, 300, 800, 600, 0x222222);
                this.jogador = this.physics.add.sprite(100, 300, null).setSize(30, 30);
                this.add.rectangle(100, 300, 30, 30, 0x00f).setOrigin(0.5).setName('playerRect');

                this.teclas = this.input.keyboard.createCursorKeys();
                this.interact = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);

                this.portas = this.physics.add.staticGroup();
                const posicoes = [200, 400, 600];
                posicoes.forEach((x, i) => {
                    const porta = this.portas.create(x, 300, null).setSize(40, 80);
                    this.add.rectangle(x, 300, 40, 80, 0x8B4513);
                    porta.setData('id', i);
                });

                this.porta404 = this.physics.add.staticSprite(750, 300, null).setSize(40, 80);
                this.add.rectangle(750, 300, 40, 80, 0x800000);

                this.interact.on('down', () => {
                    this.portas.children.each(porta => {
                        if (Phaser.Math.Distance.Between(this.jogador.x, this.jogador.y, porta.x, porta.y) < 40) {
                            this.scene.start('QuartoCena', { index: porta.getData('id') });
                        }
                    });

                    if (Phaser.Math.Distance.Between(this.jogador.x, this.jogador.y, this.porta404.x, this.porta404.y) < 40) {
                        if (state.porta404) {
                            this.scene.start('FimCena');
                        } else {
                            showMessage('A porta está trancada.');
                        }
                    }
                });
            }

            update() {
                this.jogador.setVelocity(0);
                if (this.teclas.left.isDown) this.jogador.setVelocityX(-150);
                else if (this.teclas.right.isDown) this.jogador.setVelocityX(150);

                if (this.teclas.up.isDown) this.jogador.setVelocityY(-150);
                else if (this.teclas.down.isDown) this.jogador.setVelocityY(150);
            }
        }

        class QuartoCena extends Phaser.Scene {
            constructor() {
                super('QuartoCena');
            }

            init(data) {
                this.index = data.index;
            }

            create() {
                this.add.rectangle(400, 300, 700, 500, 0x111111);
                this.add.text(400, 50, `Quarto ${this.index + 1}`, { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);

                this.jogador = this.physics.add.sprite(400, 500, null).setSize(30, 30);
                this.add.rectangle(400, 500, 30, 30, 0x00f).setOrigin(0.5);

                const fragX = Phaser.Math.Between(100, 700);
                const fragY = Phaser.Math.Between(100, 400);
                this.fragmento = this.physics.add.sprite(fragX, fragY, null).setSize(20, 20);
                this.add.rectangle(fragX, fragY, 20, 20, 0xffff00).setOrigin(0.5);

                this.teclas = this.input.keyboard.createCursorKeys();
                this.interact = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);

                this.interact.on('down', () => {
                    if (Phaser.Math.Distance.Between(this.jogador.x, this.jogador.y, this.fragmento.x, this.fragmento.y) < 40) {
                        this.fragmento.destroy();
                        state.fragmentos++;
                        if (state.fragmentos >= 3) {
                            state.porta404 = true;
                            showMessage('A porta do Quarto 404 pode ser aberta agora.');
                        } else {
                            showMessage('Fragmento coletado!');
                        }
                    }
                });

                this.input.keyboard.on('keydown-Q', () => this.scene.start('CenaPrincipal'));
            }

            update() {
                this.jogador.setVelocity(0);
                if (this.teclas.left.isDown) this.jogador.setVelocityX(-150);
                else if (this.teclas.right.isDown) this.jogador.setVelocityX(150);
                if (this.teclas.up.isDown) this.jogador.setVelocityY(-150);
                else if (this.teclas.down.isDown) this.jogador.setVelocityY(150);
            }
        }

        class FimCena extends Phaser.Scene {
            constructor() {
                super('FimCena');
            }

            create() {
                this.add.text(400, 250, 'A verdade é revelada...', { fontSize: '28px', fill: '#f00' }).setOrigin(0.5);
                this.add.text(400, 300, 'Você é o monstro.', { fontSize: '24px', fill: '#f00' }).setOrigin(0.5);
                this.add.text(400, 350, 'Tudo escurece...', { fontSize: '18px', fill: '#aaa' }).setOrigin(0.5);

                setTimeout(() => {
                    state.fragmentos = 0;
                    state.porta404 = false;
                    this.scene.start('CenaPrincipal');
                }, 4000);
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },
            scene: [CenaPrincipal, QuartoCena, FimCena]
        };

        new Phaser.Game(config);
    </script>
</body>

</html>
